srcdir=         @srcdir@
top_srcdir=     @top_srcdir@
top_builddir=   @top_builddir@
VPATH=          @srcdir@

SUBDIR=		config \
		ldap \
		pf \
		util

include ${top_builddir}/Mk/autoconf.mk
include ${top_builddir}/Mk/compile.mk
include ${top_builddir}/Mk/subdir.mk

PLUGIN_NAME=	openvpn-auth-ldap
PLUGIN_OBJS=	auth-ldap.o \
		TRObject.o \
		TRLog.o \
		TRVPNSession.o


TEST_LIB=	libauth-ldap-testing.a
TEST_OBJS=	testplugin.o

CFLAGS+=	-fPIC $(LDAP_CFLAGS) $(OPENVPN_CFLAGS)
OBJCFLAGS+=	-fPIC $(LDAP_CFLAGS) $(OPENVPN_CFLAGS)
LIBS+=		$(LDAP_LIBS) $(OBJC_LIBS) $(FLEX_LIBS) \
		-Lconfig -lauth-ldap-config \
		-Lldap -lauth-ldap-ldap \
		-Lpf -lauth-ldap-pf \
		-Lutil -lauth-ldap-util


INSTALL_LIB=		$(INSTALL) -m 755
PLUGIN_INSTALL_DIR=	$(DESTDIR)$(libdir)

all:: $(PLUGIN_FILE) $(TEST_LIB) testplugin

$(PLUGIN_FILE): $(PLUGIN_OBJS)
	$(MAKE_PLUGIN)

$(TEST_LIB): $(GEN_SRCS) $(PLUGIN_OBJS)
	$(AR) -r $@ $(PLUGIN_OBJS)

testplugin:: $(TEST_OBJS) $(TEST_LIB)
	$(CC) -o $@ ${TEST_OBJS} ${LDFLAGS} -L. ${LIBS} -lauth-ldap-testing
	
install:: $(PLUGIN_FILE)
	$(INSTALL_PLUGIN)

clean::
	rm -f $(TEST_OBJS) $(PLUGIN_OBJS) $(TEST_LIB) $(GEN_SRCS) testplugin
	$(CLEAN_PLUGIN)

distclean:: clean
	rm -f Makefile
